<!-- TOC -->

- [17. Spring 消息](#17-spring-消息)
    - [17.1 异步消息简介](#171-异步消息简介)
        - [17.1.1 发送消息](#1711-发送消息)
        - [17.1.2 评估异步消息的优点](#1712-评估异步消息的优点)
    - [17.2 使用JMS发送消息](#172-使用jms发送消息)
        - [17.2.1 在Spring中搭建消息代理](#1721-在spring中搭建消息代理)
        - [17.2.2 使用Spring的JMS模板](#1722-使用spring的jms模板)
        - [17.2.3 创建消息驱动的POJO](#1723-创建消息驱动的pojo)
        - [17.2.4 使用基于消息的RPC](#1724-使用基于消息的rpc)
    - [17.3 使用AMQP实现消息功能](#173-使用amqp实现消息功能)
        - [17.3.1 AMQP简介](#1731-amqp简介)
        - [17.3.2 配置Spring支持AMQP消息](#1732-配置spring支持amqp消息)
        - [17.3.3 使用RabbitTemplate发送消息](#1733-使用rabbittemplate发送消息)

<!-- /TOC -->

# 17. Spring 消息

有时我们需要异步的非阻塞等待的发送一些消息到另一个系统，不像上一章讲的rmi，hessian等技术，
Spring消息提供了这样一种异步发送消息的机制。

## 17.1 异步消息简介
与前几张忠介绍的远程调用机制以及REST接口类似，异步消息也适用于应用程序之间通信的。但是，在系统之间
传递消息的方式上，他和其他机制有所不同。  
消息是异步发送的，客户端不必等待服务处理消息，甚至不需要等待消息投递完成，客户端
发送消息，然后继续执行，这是因为客户端假定服务最终可以收到并处理这条消息。

### 17.1.1 发送消息
大多数人都用过邮政服务，邮政服务的关键在于间接性，我们将邮件发出，邮政公司工作人员会将贺卡送到目的地，
而我们可以继续自己的生活。  
与此类似，间接性也是异步关系的关键所在，当一个应用向另一个应用发送消息时，两个应用没有直接的联系，  
在异步消息中有两个重要的概念：`消息代理`和`目的地`。
当一个应用发送消息是，会将消息交给一个消息代理。消息代理可以确保消息被发送到指定的目的地，同时
解放发送者，使其能够继续进行其他工作。
尽管不同的消息系统会提供不同的消息路由模式，但是有两种通用的目的地：`队列（queue）`和`主题（topic）`。
每种类型都与特定的消息模型相关联，分别是`点对点模型`和`发布/订阅模型`。

- 点对点消息模型

    在点对点消息模型中，每一条消息都会有一个发送者和接受者，当消息代理得到消息后，他将消息放入一个队列中。
队列可以有多个接受者，但是一条消息只能被一个接受者取走。

- 发布-订阅消息模型 
    
    在发布订阅-模型中，消息会发送给一个主题，与队列类似，多个接受者都可以监听一个主题，
    但是消息不再是之投递给一个接受者，而是主题的所有订阅者都会收到消息的副本。

### 17.1.2 评估异步消息的优点

同步通信比较容易理解，简单，但是存在几个限制：
- 同步通信意味着等待，当客户端调用远程服务的方法时，他必须等待远程方法结束后才能继续执行，如果服务端响应比较慢，
就会对客户端的性能造成影响。
- 客户端通过服务接口与远程服务相耦合，如果服务的接口发生变化，此服务的所有客户端都需要做出相应的改变。
- 客户端与远程服务的位置耦合，客户端必须配置服务的网络位置，这样他才知道符合与服务端通信
- 客户端与服务的可用性相耦合，如果服务端不可用，那么客户端实际上也不可用

而异步消息可以解决这些缺点
- 无需等待
- 面向消息和解耦
- 位置独立
- 确保投递

## 17.2 使用JMS发送消息

Java 消息服务是一个java标准，定义了使用消息代理的通用API。
Spring通过模板的抽象，为JMS功能提供了支持，这个特模板就是JMSTemplate，JMSTemplate能够非常同意的在消息生产方发送
队列和主题消息，在消费的一方也能容易的接收这些消息，Spring还提供了消息驱动POJO。但是在发送
和接收消息之前，我们首先需要一个消息代理。

### 17.2.1 在Spring中搭建消息代理

ActiveMQ是一个伟大的开源消息代理产品，也是使用JMS进行异步消息传递的最佳选择。

- 创建连接工厂

- 声明ActiveMQ消息目的地

### 17.2.2 使用Spring的JMS模板

- 处理失控的JMS代码

- 使用JMS模板

- 发送消息

- 设置默认目的地

- 在发送时，对消息进行转换

- 接收消息

### 17.2.3 创建消息驱动的POJO

- 创建消息监听器

- 配置消息监听器


### 17.2.4 使用基于消息的RPC

- 导出基于JMS的服务

- 使用基于JMS的服务

## 17.3 使用AMQP实现消息功能

对于Java和Spring开发者来说，JMS并不是唯一的消息可选方案，在过去的几年中，
高级消息队列协议（AMQP）得到了广泛的关注。
AMQP具有多项JMS不具备的优势，首先AMOP为消息定义了线路层协议，而JMS所定义的是API规范。
AMQP定义的消息格式不仅能跨不同的AMOP实现，还可以跨语言和平台。

### 17.3.1 AMQP简介

### 17.3.2 配置Spring支持AMQP消息

- 声明队列，Exchange以及binding

### 17.3.3 使用RabbitTemplate发送消息
